### TCP 서버에서의 기본적인 함수호출 순서

* 대부분의 TCP 서버 프로그램은 이 순서로 구현이 됨.

```java
   socket()     /* 소켓생성 */
      ↓
    bind()      /* 소켓 주소할당 */
      ↓
   listen()     /* 연결요청 대기상태 */
      ↓
   accept()     /* 연결허용 */
      ↓
read()/write()  /* 데이터 송수신 */
      ↓
   close()      /* 연결종료 */
```

<br>

### 연결요청 대기상태로의 진입

* **`listen`** 함수가 호출되어야 클라이언트가 연결요청을 할 수 있는 상태가 됨. 

* 즉, **`listen`** 함수가 호출되어야 클라이언트는 연결요청을 위해서 **`connect`*** 함수를 호출할 수 있음. 

```C
#include <sys/socket.h>

/* @return : 성공 시 0, 실패 시 -1 반환
 * @param  :     sock : 연결요청 대기상태에 두고자 하는 소켓의 파일 디스크립터 전달, 
 *                      이 함수의 인자로 전달된 디스크립터의 소켓이 서버 소켓(리스닝 소켓)이 됨.
 *            backlog : 연결요청 대기 큐(Queue)의 크기정보 전달, 
 *                      5가 전달되면 큐의 크기가 5가 되어 클라이언트의 연결요청을 5개 대기시킬 수 있음.
 */
 int listen(int sock, int baklog);
```

<br>

*  **연결요청 대기상태** 와 **연결요청 대기 큐**
   
>   + 클라이언트의 연결요청도 인터넷을 통해서 흘러 들어오는 일종의 데이터 전송이기 때문에, 이것을 받아들이려면 당연히 소켓이 하나 있어야함. 서버 소켓의 역할이 바로 이것. **즉, 연결 요청을 맞이하는, 일종의 문지기 역할**.
>   
>   + 클라이언트가 서버 소켓에게 연결요청을 보내면, 서버 소켓은 클라이언트의 연결요청을 대기실로 안내함. 이 대기실을 가리켜 **연결요청 대기 큐** 라 함.
>
>   + **`listen`** 함수가 호출되면, 서버 소켓이 만들어지고,**`listen`** 함수의 두 번째 인자로 전달되는 정수의 크기에 해당하는 연결요청 대기 큐가 만들어짐.
>   
>   + 서버 소켓과 연결요청 대기 큐가 완전히 준비되어서 클라이언트의 연결요청이 받아들일 수 있는 상태를 가리켜 **연결요청 대기상태**라 함.
>   
>   + 즉, **연결요청 대기상태**에 있다는 것은 클라이언트가 연결요청을 했을 때 연결이 수락될 때까지 연결요청 자체를 대기시킬 수 있는 상태에 있다는 것을 의미.
   

<br>

### 클라이언트의 연결요청 수락

* **`listen`** 함수호출 이후에 클라이언트의 연결요청이 들어왔다면, 들어온 순서대로 연결요청을 수락해야 함.

* 연결요청을 수락한다는 것은 클라이언트와 데이터를 주고받을 수 있는 상태가 됨을 의미함.


* 클라이언트와의 데이터 송수신을 위해 소켓이 하나 더 만들어야함. 이 소켓을 직접 만들 필요는 없음.

* **다음 함수의 호출결과**로 이 소켓이 만들어지고 이 소켓은 연결요청을 한 클라이언트 소켓과 자동으로 연결됨.

```C
#include <sys/socket.h>

/* @return : 성공 시 생성된 소켓의 파일 디스크립터, 실패시 -1 반환
 * @param  :     sock : 서버 소켓의 파일 디스크립터 전달.  
 *               addr : 연결요청 한 클라이언트 주소정보를 담을 변수의 주소 값 전달, 함수호출이 완료되면
 *                      인자로 전달된 주소의 변수에는 클라이언트의 주소정보가 채워짐.
 *            addrlen : 두 번째 매개변수 addr에 전달된 주소의 변수 크기를 바이트 단위로 전달, 단 크기정보를 변수에
 *                      저장한 다음에 변수의 주소 값을 전달한다. 그리고 함수호출이 완료되면 크기 정보로 채워져있던
 *                      변수에는 클라이언트 주소정보 길이가 바이트 단위로 계산되어 채워진다.
 */
 int accept(int sock, struct sockaddr * addr, socklen_t * addrlen);
```

* **`accept`** 함수는 **연결요청 대기 큐** 에서 대기중인 클라이언트의 연결요청을 수락하는 기능의 함수.


* **`accept`** 함수는 호출성공 시 내부적으로 데이터 입출력에 사용할 소켓을 생성하고, 그 소켓의 파일 디스크립터를 반환. 


* 중요한 점은 소켓이 자동으로 생성되어, 연결요청을 한 클라이언트 소켓에 연결까지 이뤄진다는 점.
